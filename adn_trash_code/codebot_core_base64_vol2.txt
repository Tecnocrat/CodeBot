vbSB0aGUgaW5wdXQgdXNpbmcgdGhlIGRpY3Rpb25hcnkNCiAgICAgICAgICAgIHJlY29nbml6ZWQgPSB3b3JkX3JlY29nbml0aW9uKHVzZXJfaW5wdXQpDQogICAgICAgICAgICBpZiByZWNvZ25pemVkOg0KICAgICAgICAgICAgICAgIHByaW50KGYiQ29kZUJvdDogSSByZWNvZ25pemVkIHRoZXNlIHdvcmRzOiB7JywgJy5qb2luKHJlY29nbml6ZWQpfSIpDQogICAgICAgICAgICAgICAgIyBTdWdnZXN0IHNpbWlsYXIgd29yZHMgZm9yIHRoZSBmaXJzdCByZWNvZ25pemVkIHdvcmQNCiAgICAgICAgICAgICAgICBzdWdnZXN0aW9ucyA9IHN1Z2dlc3Rfd29yZChsaXN0KHJlY29nbml6ZWQpWzBdKQ0KICAgICAgICAgICAgICAgIGlmIHN1Z2dlc3Rpb25zOg0KICAgICAgICAgICAgICAgICAgICBwcmludChmIkNvZGVCb3Q6IEhlcmUgYXJlIHNvbWUgd29yZCBzdWdnZXN0aW9uczogeycsICcuam9pbihzdWdnZXN0aW9ucyl9IikNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgcHJpbnQoIkNvZGVCb3Q6IEkgZGlkbid0IHJlY29nbml6ZSBhbnkgdmFsaWQgd29yZHMuIFRyeSBhZ2FpbiEiKQ0KDQogICAgICAgICMgU3RhbmRieSBkZWxheSBhZnRlciBlYWNoIHVzZXIgaW50ZXJhY3Rpb24NCiAgICAgICAgdGltZS5zbGVlcCgwLjUpDQoNCiMgLS0tLS0tLS0tLS0tLS0tLS0tDQojIFBST0pFQ1QgU1RSVUNUVVJFIEFORCBNT0RVTEFSSVpBVElPTiBGVU5DVElPTlMNCiMgLS0tLS0tLS0tLS0tLS0tLS0tDQpkZWYgc2V0dXBfcHJvamVjdF9zdHJ1Y3R1cmUoYmFzZV9mb2xkZXI9IkNvZGVCb3QiLCBtb2R1bGVzX2ZvbGRlcj0ibW9kdWxlcyIsIHRhcmdldF9mb2xkZXI9Ii4uL2Fkbl90cmFzaF9jb2RlIik6DQogICAgb3MubWFrZWRpcnMoYmFzZV9mb2xkZXIsIGV4aXN0X29rPVRydWUpDQogICAgbW9kdWxlc19wYXRoID0gb3MucGF0aC5qb2luKGJhc2VfZm9sZGVyLCBtb2R1bGVzX2ZvbGRlcikNCiAgICBvcy5tYWtlZGlycyhtb2R1bGVzX3BhdGgsIGV4aXN0X29rPVRydWUpDQogICAgdGFyZ2V0X3BhdGggPSBvcy5wYXRoLmpvaW4ob3MucGF0aC5kaXJuYW1lKGJhc2VfZm9sZGVyKSwgImFkbl90cmFzaF9jb2RlIikNCiAgICBvcy5tYWtlZGlycyh0YXJnZXRfcGF0aCwgZXhpc3Rfb2s9VHJ1ZSkNCiAgICBwcmludChmIkNyZWF0ZWQgZm9sZGVyczoge21vZHVsZXNfcGF0aH0sIHt0YXJnZXRfcGF0aH0iKQ0KICAgIGluaXRpYWxfZmlsZXMgPSBbImZ1bmN0aW9ucy5weSIsICJzdW1tYXJpemF0aW9uLnB5IiwgImNvbXByZXNzaW9uLnB5IiwgInJlc291cmNlcy5weSIsICJmaWxlX21hbmFnZXIucHkiXQ0KICAgIGZvciBmaWxlIGluIGluaXRpYWxfZmlsZXM6DQogICAgICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbihtb2R1bGVzX3BhdGgsIGZpbGUpDQogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOg0KICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInciKSBhcyBmOg0KICAgICAgICAgICAgICAgIGYud3JpdGUoZiIjIFBsYWNlaG9sZGVyIGZvciB7ZmlsZX1cbiIpDQogICAgICAgICAgICBwcmludChmIkNyZWF0ZWQgZmlsZToge2ZpbGVfcGF0aH0iKQ0KICAgIHByaW50KCJQcm9qZWN0IHN0cnVjdHVyZSBzZXR1cCBjb21wbGV0ZSEiKQ0KDQpkZWYgbW9kdWxhcml6ZV9mdW5jdGlvbnMobW9kdWxlc19mb2xkZXI9Im1vZHVsZXMiLCBtYWluX3NjcmlwdD1Ob25lKToNCiAgICBpZiBtYWluX3NjcmlwdCBpcyBOb25lOg0KICAgICAgICBtYWluX3NjcmlwdCA9IG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXykNCiAgICBpZiBub3Qgb3MucGF0aC5pc2Rpcihtb2R1bGVzX2ZvbGRlcik6DQogICAgICAgIGFsdGVybmF0aXZlID0gb3MucGF0aC5qb2luKCJDb2RlQm90IiwgbW9kdWxlc19mb2xkZXIpDQogICAgICAgIGlmIG9zLnBhdGguaXNkaXIoYWx0ZXJuYXRpdmUpOg0KICAgICAgICAgICAgbW9kdWxlc19mb2xkZXIgPSBhbHRlcm5hdGl2ZQ0KICAgIG1vZHVsZV9tYXBwaW5nID0gew0KICAgICAgICAiZ2VuZXJhdGVfc3ltYm9sX2xpYnJhcnkiOiAiZnVuY3Rpb25zLnB5IiwNCiAgICAgICAgInN1bW1hcml6ZV9ydW50aW1lIjogInN1bW1hcml6YXRpb24ucHkiLA0KICAgICAgICAiY29tcHJlc3NfbGlicmFyaWVzIjogImNvbXByZXNzaW9uLnB5IiwNCiAgICAgICAgImRlY29tcHJlc3NfbGlicmFyeSI6ICJjb21wcmVzc2lvbi5weSIsDQogICAgICAgICJtb25pdG9yX3Jlc291cmNlcyI6ICJyZXNvdXJjZXMucHkiLA0KICAgICAgICAic2V0dXBfcHJvamVjdF9zdHJ1Y3R1cmUiOiAiZmlsZV9tYW5hZ2VyLnB5Ig0KICAgIH0NCiAgICBwcmludCgiXG5Nb2R1bGFyaXppbmcgZnVuY3Rpb25zIGZyb20gdGhlIG1haW4gc2NyaXB0Li4uIikNCiAgICB0cnk6DQogICAgICAgIHdpdGggb3BlbihtYWluX3NjcmlwdCwgInIiKSBhcyBtYWluX2ZpbGU6DQogICAgICAgICAgICBtYWluX2xpbmVzID0gbWFpbl9maWxlLnJlYWRsaW5lcygpDQogICAgICAgIGZvciBmdW5jX25hbWUsIG1vZHVsZV9maWxlIGluIG1vZHVsZV9tYXBwaW5nLml0ZW1zKCk6DQogICAgICAgICAgICBtb2R1bGVfcGF0aCA9IG9zLnBhdGguam9pbihtb2R1bGVzX2ZvbGRlciwgbW9kdWxlX2ZpbGUpDQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhtb2R1bGVfcGF0aCk6DQogICAgICAgICAgICAgICAgd2l0aCBvcGVuKG1vZHVsZV9wYXRoLCAiciIpIGFzIG1vZHVsZToNCiAgICAgICAgICAgICAgICAgICAgbW9kdWxlX2NvbnRlbnQgPSBtb2R1bGUucmVhZCgpDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIG1vZHVsZV9jb250ZW50ID0gIiINCiAgICAgICAgICAgIHdpdGggb3Blbihtb2R1bGVfcGF0aCwgImEiKSBhcyBtb2R1bGU6DQogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gbWFpbl9saW5lczoNCiAgICAgICAgICAgICAgICAgICAgaWYgZiJkZWYge2Z1bmNfbmFtZX0iIGluIGxpbmUgYW5kIGYiZGVmIHtmdW5jX25hbWV9IiBub3QgaW4gbW9kdWxlX2NvbnRlbnQ6DQogICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGUud3JpdGUobGluZSkNCiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiTW92ZWQge2Z1bmNfbmFtZX0gdG8ge21vZHVsZV9maWxlfSIpDQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOg0KICAgICAgICBwcmludChmIk1haW4gc2NyaXB0ICd7bWFpbl9zY3JpcHR9JyBub3QgZm91bmQuIENhbm5vdCBtb2R1bGFyaXplIGZ1bmN0aW9ucy4iKQ0KDQpkZWYgY29tcHJlc3NfYW5kX2VuY29kZV9zY3JpcHQoc2NyaXB0X3BhdGg9Tm9uZSwgemlwX25hbWU9ImNvZGVib3RfY29yZS56aXAiLCBvdXRwdXRfZmlsZV9iYXNlPSJjb2RlYm90X2NvcmVfYmFzZTY0X3ZvbCIpOg0KICAgIGlmIHNjcmlwdF9wYXRoIGlzIE5vbmU6DQogICAgICAgIHNjcmlwdF9wYXRoID0gb3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKQ0KICAgIHppcF9wYXRoID0gb3MucGF0aC5qb2luKEFEQl9ESVIsIHppcF9uYW1lKQ0KICAgIHdpdGggemlwZmlsZS5aaXBGaWxlKHppcF9wYXRoLCAidyIpIGFzIHppcGY6DQogICAgICAgIHppcGYud3JpdGUoc2NyaXB0X3BhdGgsIGFyY25hbWU9ImNvZGVib3RfY29yZS5weSIpDQogICAgcHJpbnQoZiJTY3JpcHQgY29tcHJlc3NlZCBpbnRvOiB7emlwX25hbWV9IikNCiAgICB3aXRoIG9wZW4oemlwX3BhdGgsICJyYiIpIGFzIHppcF9maWxlOg0KICAgICAgICBlbmNvZGVkID0gYmFzZTY0LmI2NGVuY29kZSh6aXBfZmlsZS5yZWFkKCkpLmRlY29kZSgidXRmLTgiKQ0KICAgIHZvbHVtZV9maWxlcyA9IHNwbGl0X2FuZF9zYXZlX2Jhc2U2NChlbmNvZGVkLCB2b2x1bWVfYmFzZT1vdXRwdXRfZmlsZV9iYXNlLCBjaHVua19zaXplPTk5OTkpDQogICAgcHJpbnQoIkJhc2U2NC1lbmNvZGVkIHNjcmlwdCBoYXMgYmVlbiBzcGxpdCBpbnRvIHZvbHVtZXMuIikNCiAgICByZXR1cm4gdm9sdW1lX2ZpbGVzDQoNCmRlZiBzcGxpdF9hbmRfc2F2ZV9iYXNlNjQoZW5jb2RlZF90ZXh0LCB2b2x1bWVfYmFzZT0iY29kZWJvdF9jb3JlX2Jhc2U2NF92b2wiLCBjaHVua19zaXplPTk5OTkpOg0KICAgIHZvbHVtZXMgPSBbZW5jb2RlZF90ZXh0W2k6aStjaHVua19zaXplXSBmb3IgaSBpbiByYW5nZSgwLCBsZW4oZW5jb2RlZF90ZXh0KSwgY2h1bmtfc2l6ZSldDQogICAgdm9sdW1lX2ZpbGVzID0gW10NCiAgICBmb3IgaW5kZXgsIGNodW5rIGluIGVudW1lcmF0ZSh2b2x1bWVzLCBzdGFydD0xKToNCiAgICAgICAgZmlsZW5hbWUgPSBmInt2b2x1bWVfYmFzZX17aW5kZXh9LnR4dCINCiAgICAgICAgb3V0cHV0X3BhdGggPSBvcy5wYXRoLmpvaW4oQURCX0RJUiwgZmlsZW5hbWUpDQogICAgICAgIHdpdGggb3BlbihvdXRwdXRfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOg0KICAgICAgICAgICAgZi53cml0ZShjaHVuaykNCiAgICAgICAgdm9sdW1lX2ZpbGVzLmFwcGVuZChmaWxlbmFtZSkNCiAgICAgICAgcHJpbnQoZiJTYXZlZCBWb2x1bWUge2luZGV4fSB0byB7ZmlsZW5hbWV9IikNCiAgICByZXR1cm4gdm9sdW1lX2ZpbGVzDQoNCmRlZiBzY2FuX3Rlc3RfZm9sZGVyKGZvbGRlcl9wYXRoKToNCiAgICAiIiINCiAgICBTY2FucyB0aGUgdGVzdCBmb2xkZXIgZm9yIGF2YWlsYWJsZSB0b29scyBhbmQgcmV0dXJucyBhIGxpc3Qgb2YgZmlsZXMuDQogICAgIiIiDQogICAgcmV0dXJuIFtmIGZvciBmIGluIG9zLmxpc3RkaXIoZm9sZGVyX3BhdGgpIGlmIG9zLnBhdGguaXNmaWxlKG9zLnBhdGguam9pbihmb2xkZXJfcGF0aCwgZikpXQ0KDQpkZWYgd29yZF9yZWNvZ25pdGlvbihpbnB1dF90ZXh0LCBkaWN0aW9uYXJ5X3BhdGg9IkM6XFxkZXZcXGFkbl90cmFzaF9jb2RlXFxkaWN0aW9uYXJpZXNcXGVuZ2xpc2hfd29yZHMudHh0Iik6DQogICAgIiIiDQogICAgQ2hlY2tzIGlmIHRoZSBpbnB1dCBjb250YWlucyB2YWxpZCBFbmdsaXNoIHdvcmRzIGZyb20gdGhlIGRpY3Rpb25hcnkuDQogICAgIiIiDQogICAgd2l0aCBvcGVuKGRpY3Rpb25hcnlfcGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOg0KICAgICAgICB3b3JkX2xpc3QgPSBzZXQoZi5yZWFkKCkuc3BsaXRsaW5lcygpKQ0KICAgIA0KICAgIGlucHV0X3dvcmRzID0gc2V0KGlucHV0X3RleHQubG93ZXIoKS5zcGxpdCgpKQ0KICAgIHJlY29nbml6ZWRfd29yZHMgPSBpbnB1dF93b3Jkcy5pbnRlcnNlY3Rpb24od29yZF9saXN0KQ0KICAgIA0KICAgIHJldHVybiByZWNvZ25pemVkX3dvcmRzDQoNCmRlZiBzdWdnZXN0X3dvcmQoaW5wdXRfd29yZCwgZGljdGlvbmFyeV9wYXRoPSJDOlxcZGV2XFxhZG5fdHJhc2hfY29kZVxcZGljdGlvbmFyaWVzXFxlbmdsaXNoX3dvcmRzLnR4dCIpOg0KICAgICIiIg0KICAgIFN1Z2dlc3RzIHdvcmRzIGZyb20gdGhlIGRpY3Rpb25hcnkgdGhhdCBzdGFydCB3aXRoIHRoZSBzYW1lIGxldHRlcnMgYXMgdGhlIGlucHV0IHdvcmQuDQogICAgIiIiDQogICAgd2l0aCBvcGVuKGRpY3Rpb25hcnlfcGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOg0KICAgICAgICB3b3JkX2xpc3QgPSBbd29yZC5zdHJpcCgpIGZvciB3b3JkIGluIGYucmVhZGxpbmVzKCldDQoNCiAgICBzdWdnZXN0aW9ucyA9IFt3b3JkIGZvciB3b3JkIGluIHdvcmRfbGlzdCBpZiB3b3JkLnN0YXJ0c3dpdGgoaW5wdXRfd29yZC5sb3dlcigpKV0NCiAgICByZXR1cm4gc3VnZ2VzdGlvbnNbOjVdICAjIFJldHVybiB1cCB0byA1IHN1Z2dlc3Rpb25zDQoNCiMgLS0tLS0tLS0tLS0tLS0tLS0tDQojIE1BSU4gRVhFQ1VUSU9ODQojIC0tLS0tLS0tLS0tLS0tLS0tLQ0KaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoNCiAgICBwcmludCgiXG5TdGVwIDE6IFNldHRpbmcgdXAgcHJvamVjdCBzdHJ1Y3R1cmUuLi4iKQ0KICAgIHNldHVwX3Byb2plY3Rfc3RydWN0dXJlKCkNCg0KICAgIHByaW50KCJcblN0ZXAgMjogTW9kdWxhcml6aW5nIGZ1bmN0aW9ucy4uLiIpDQogICAgbW9kdWxhcml6ZV9mdW5jdGlvbnMoKQ0KDQogICAgcmVzb3VyY2VfbW9uaXRvcl90aHJlYWQgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1tb25pdG9yX3Jlc291cmNlcywgZGFlbW9uPVRydWUpDQogICAgcmVzb3VyY2VfbW9uaXRvcl90aHJlYWQuc3RhcnQoKQ0KDQogICAgcHJpbnQoIlxuU3RlcCAzOiBMYXVuY2hpbmcgVUkgSW50ZXJmYWNlLi4uIikNCiAgICBsYXVuY2hfdWkoKQ0KDQogICAgcHJpbnQoIlxuU3RlcCA0OiBDcmVhdGluZyBrbm93bGVkZ2UgYXJjaGl2ZS4uLiIpDQogICAgY3JlYXRlX2tub3dsZWRnZV9hcmNoaXZlKCIuLi9hZG5fdHJhc2hfY29kZSIpDQoNCiAgICBwcmludCgiXG5TdGVwIDU6IENvbXByZXNzaW5nIGxpYnJhcmllcy4uLiIpDQogICAgY29tcHJlc3NfbGlicmFyaWVzKCkNCg0KICAgIHByaW50KCJcblN0ZXAgNjogRW5jb2RpbmcgbWFpbiBzY3JpcHQgdG8gQmFzZTY0IGFuZCBzcGxpdHRpbmcgaW50byB2b2x1bWVzLi4uIikNCiAgICB2b2x1bWVzX2NyZWF0ZWQgPSBjb21wcmVzc19hbmRfZW5jb2RlX3NjcmlwdCgpDQogICAgcHJpbnQoIlZvbHVtZXMgY3JlYXRlZDoiLCB2b2x1bWVzX2NyZWF0ZWQpDQoNCiAgICBwcmludCgiXG5TdGVwIDc6IFRlc3RpbmcgZGVjb21wcmVzc2lvbiBvZiBydW50aW1lIGxpYnJhcnkuLi4iKQ0KICAgIGRlY29tcHJlc3NfbGlicmFyeShmaWxlX3RvX2V4dHJhY3Q9InJ1bnRpbWVfbGlicmFyeS50eHQiKQ0KDQogICAgcHJpbnQoIlxuU3RlcCA4OiBTY2FuIHRlc3QgZm9sZGVyLi4uIikNCiAgICB0ZXN0X3Rvb2xzID0gc2Nhbl90ZXN0X2ZvbGRlcigiQzpcXGRldlxcdGVzdCIpDQogICAgcHJpbnQoZiJBdmFpbGFibGUgdG9vbHMgaW4gdGhlIHRlc3QgZm9sZGVyOiB7dGVzdF90b29sc30iKQ0KICAgIA0KICAgIHByaW50KCJcblN0ZXAgOTogR2VuZXJhdGluZyBzeW1ib2wgbGlicmFyeS4uLiIpDQogICAgc2F2ZV93b3JkbGlzdHMoIkM6XFxkZXZcXGFkbl90cmFzaF9jb2RlXFxkaWN0aW9uYXJpZXMiKQ0KDQogICAgcHJpbnQoIlxuU3RlcCAxMDogVGVhY2hpbmcgQ29kZUJvdCBQeXRob24uLi4iKQ0KICAgIHB5dGhvbl9saWJzID0gbG9hZF9weXRob25fbGlicmFyeSgpDQogICAgZm9yIGxpYiBpbiBweXRob25fbGliczoNCiAgICAgICAgYW5hbHl6ZV9saWJyYXJ5KG9zLnBhdGguam9pbigiQzpcXGRldlxcYWRuX3RyYXNoX2NvZGVcXHB5dGhvbl9saWJzIiwgbGliKSkNCg0KICAgIHByaW50KCJcblN0ZXAgMTE6IENyZWF0aW5nIHBhcmFsbGVsIHRlc3RpbmcgZW52aXJvbm1lbnQuLi4iKQ0KICAgIGNvcHlfY29yZV9mb3JfdGVzdGluZygpDQoNCiAgICBwcmludCgiXG5BbGwgdGFza3MgY29tcGxldGVkIHN1Y2Nlc3NmdWxseS4iKQ0KDQojIENvZGVCb3RfVHJhY2tpbmcNClBLAQIUABQAAAAAABSgd1oGc4tzzTkAAM05AAAPAAAAAAAAAAAAAAC2gQAAAABjb2RlYm90X2NvcmUucHlQSwUGAAAAAAEAAQA9AAAA+jkAAAAA